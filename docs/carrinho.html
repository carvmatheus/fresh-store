<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrinho - Da Horta Distribuidora</title>
    <meta name="description" content="Finalize seu pedido de produtos frescos">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* ========== CART PAGE STYLES ========== */
        .cart-page-wrapper {
            min-height: calc(100vh - 200px);
            background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
            padding: 2rem 1rem;
        }

        .cart-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Progress Steps */
        .checkout-progress {
            display: flex;
            justify-content: center;
            margin-bottom: 2.5rem;
            padding: 0 1rem;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-400);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .progress-step.active {
            color: var(--primary);
        }

        .progress-step.completed {
            color: var(--primary);
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .progress-step.active .step-number {
            background: var(--primary);
            color: white;
        }

        .progress-step.completed .step-number {
            background: var(--primary);
            color: white;
        }

        .progress-line {
            width: 60px;
            height: 3px;
            background: var(--gray-200);
            margin: 0 1rem;
        }

        .progress-line.completed {
            background: var(--primary);
        }

        /* Page Title */
        .cart-page-title {
            text-align: center;
            margin-bottom: 2rem;
        }

        .cart-page-title h1 {
            font-size: 2rem;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .cart-page-title p {
            color: var(--gray-500);
        }

        /* Main Grid */
        .cart-main-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 2rem;
            align-items: start;
        }

        @media (max-width: 968px) {
            .cart-main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Items Section */
        .cart-items-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            overflow: hidden;
        }

        .cart-items-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-items-header h2 {
            font-size: 1.1rem;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .items-count {
            background: var(--primary);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .clear-cart-btn {
            color: var(--gray-500);
            background: none;
            border: none;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: color 0.2s;
        }

        .clear-cart-btn:hover {
            color: #ef4444;
        }

        /* Cart Item */
        .cart-page-item {
            display: flex;
            gap: 1rem;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            transition: background 0.2s;
        }

        .cart-page-item:hover {
            background: rgba(34, 197, 94, 0.02);
        }

        .cart-page-item:last-child {
            border-bottom: none;
        }

        .item-image {
            width: 90px;
            height: 90px;
            border-radius: 0.75rem;
            object-fit: cover;
            background: var(--gray-100);
            flex-shrink: 0;
        }

        .item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .item-top {
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .item-name {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 1rem;
        }

        .item-unit-price {
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        .item-remove-btn {
            background: none;
            border: none;
            color: var(--gray-400);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.25rem;
            transition: all 0.2s;
        }

        .item-remove-btn:hover {
            color: #ef4444;
            transform: scale(1.1);
        }

        .item-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--gray-100);
            border-radius: 2rem;
            padding: 0.25rem;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: white;
            color: var(--gray-700);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:hover {
            background: var(--primary);
            color: white;
        }

        .qty-value {
            min-width: 32px;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
        }

        .item-total-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Empty Cart */
        .empty-cart-container {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-cart-icon {
            font-size: 5rem;
            opacity: 0.3;
            margin-bottom: 1.5rem;
        }

        .empty-cart-container h2 {
            font-size: 1.5rem;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .empty-cart-container p {
            color: var(--gray-500);
            margin-bottom: 1.5rem;
        }

        .empty-cart-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary);
            color: white;
            padding: 0.875rem 1.5rem;
            border-radius: 2rem;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }

        .empty-cart-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Summary Card */
        .summary-card-modern {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: sticky;
            top: 1rem;
            overflow: hidden;
        }

        .summary-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.25rem 1.5rem;
        }

        .summary-header h2 {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-body {
            padding: 1.5rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            font-size: 0.95rem;
            color: var(--gray-600);
        }

        .summary-row.total {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--gray-900);
            border-top: 2px dashed var(--gray-200);
            margin-top: 0.5rem;
            padding-top: 1rem;
        }

        .summary-row.total span:last-child {
            color: var(--primary);
        }

        .promo-code-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-100);
        }

        .promo-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .promo-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }

        .promo-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .promo-btn {
            padding: 0.75rem 1rem;
            background: var(--gray-100);
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .promo-btn:hover {
            background: var(--gray-200);
        }

        .checkout-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .continue-shopping {
            display: block;
            text-align: center;
            margin-top: 1rem;
            color: var(--gray-500);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .continue-shopping:hover {
            color: var(--primary);
        }

        .security-badges {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-100);
        }

        .security-badge {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Shipping Estimate */
        .shipping-estimate {
            background: rgba(34, 197, 94, 0.08);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .shipping-estimate-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cep-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .cep-input {
            flex: 1;
            padding: 0.625rem 0.875rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }

        .cep-btn {
            padding: 0.625rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cep-btn:hover {
            background: var(--primary-dark);
        }

        /* Benefits */
        .cart-benefits {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        @media (max-width: 768px) {
            .cart-benefits {
                grid-template-columns: 1fr;
            }
        }

        .benefit-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.04);
        }

        .benefit-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        .benefit-title {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .benefit-text {
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        /* Promo styles for cart page */
        .cart-page-item.has-promo {
            position: relative;
            background: linear-gradient(135deg, #f0fdf4, #ffffff);
            border-left: 3px solid #22c55e;
        }

        .item-promo-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.688rem;
            font-weight: 700;
            z-index: 5;
        }

        .item-name .promo-tag {
            display: inline-block;
            background: #22c55e;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.625rem;
            font-weight: 600;
            margin-left: 6px;
            vertical-align: middle;
        }

        .item-unit-price .original-price,
        .item-total-price .original-total {
            color: #9ca3af;
            font-size: 0.813rem;
        }

        .item-unit-price .promo-price {
            color: #22c55e;
            font-weight: 600;
        }

        .item-total-price.promo-total {
            color: #22c55e;
        }

        .summary-savings {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #166534;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .summary-savings strong {
            color: #15803d;
        }
    </style>
</head>
<body>
    <!-- Banner Header -->
    <div class="banner-header" onclick="goToHome()" style="cursor: pointer;" title="Clique para voltar √† home">
        <img src="images/Header_da_horta.png" alt="Da Horta Distribuidora" class="banner-image">
    </div>

    <!-- Navigation Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="header-left">
                    <button class="hamburger-btn" onclick="toggleMenu()" aria-label="Menu">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <a href="index.html" class="continue-shopping-btn">
                        ‚Üê Continuar Comprando
                    </a>
                </div>
                
                <div class="header-actions">
                    <div class="search-container">
                        <input 
                            type="text" 
                            id="searchInput" 
                            class="search-input" 
                            placeholder="Buscar produtos..."
                            onkeyup="handleSearch(this.value)">
                        <span class="search-icon">üîç</span>
                    </div>
                    <a href="carrinho.html" class="cart-btn active">
                        üõí Carrinho <span class="cart-badge" id="cartBadge">0</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Side Menu -->
    <nav class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h3>Menu</h3>
            <button class="close-menu-btn" onclick="toggleMenu()">‚úï</button>
        </div>
        <div class="side-menu-content">
            <ul class="menu-list">
                <li><a href="index.html">üè† In√≠cio</a></li>
                <li><a href="carrinho.html" class="active">üõí Carrinho</a></li>
                <li><a href="cliente.html">üì¶ Meus Pedidos</a></li>
                <li class="menu-divider"></li>
                <li><a href="login.html">üîê Entrar</a></li>
            </ul>
        </div>
    </nav>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="closeOverlays()"></div>

    <!-- Main Content -->
    <main class="cart-page-wrapper">
        <div class="cart-container">
            <!-- Progress Steps -->
            <div class="checkout-progress">
                <div class="progress-step active">
                    <span class="step-number">1</span>
                    <span>Carrinho</span>
        </div>
                <div class="progress-line"></div>
                <div class="progress-step">
                    <span class="step-number">2</span>
                    <span>Dados</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step">
                    <span class="step-number">3</span>
                    <span>Pagamento</span>
                </div>
            </div>

            <!-- Page Title -->
            <div class="cart-page-title">
                <h1>üõí Meu Carrinho</h1>
                <p>Revise seus produtos antes de continuar</p>
                    </div>
                    
            <!-- Empty Cart -->
            <div class="empty-cart-container" id="emptyCartPage" style="display: none;">
                <div class="empty-cart-icon">üõí</div>
                <h2>Seu carrinho est√° vazio</h2>
                <p>Explore nossos produtos frescos e adicione ao carrinho</p>
                <a href="index.html" class="empty-cart-btn">
                    ü•¨ Ver Produtos
                </a>
                    </div>

            <!-- Cart Content -->
            <div class="cart-main-grid" id="cartContent">
                <!-- Items Section -->
                <div class="cart-items-card">
                    <div class="cart-items-header">
                        <h2>
                            üì¶ Itens do Pedido
                            <span class="items-count" id="itemsCount">0</span>
                        </h2>
                        <button class="clear-cart-btn" onclick="clearCart()">
                            üóëÔ∏è Limpar
                        </button>
                    </div>
                    <div id="cartItemsList">
                        <!-- Items rendered by JS -->
                    </div>
                </div>

                <!-- Summary Section -->
                <div class="summary-card-modern">
                    <div class="summary-header">
                        <h2>üìã Resumo do Pedido</h2>
                    </div>
                    <div class="summary-body">
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span id="summarySubtotal">R$ 0,00</span>
                        </div>
                        <div class="summary-row">
                            <span>Frete</span>
                            <span id="summaryShipping">Calcular</span>
                        </div>
                        <div id="summarySavings" class="summary-savings" style="display: none;"></div>
                        <div class="summary-row total">
                            <span>Total</span>
                            <span id="summaryTotal">R$ 0,00</span>
                    </div>

                        <!-- Shipping Estimate -->
                        <div class="shipping-estimate">
                            <div class="shipping-estimate-title">
                                üöö Calcular Frete
                            </div>
                            <div class="cep-input-group">
                                <input type="text" class="cep-input" id="cepInput" placeholder="00000-000" maxlength="9">
                                <button class="cep-btn" onclick="calculateShipping()">OK</button>
                            </div>
                        </div>

                        <!-- Promo Code -->
                        <div class="promo-code-section">
                            <div class="promo-input-group">
                                <input type="text" class="promo-input" placeholder="Cupom de desconto">
                                <button class="promo-btn">Aplicar</button>
                    </div>
                </div>

                        <button class="checkout-btn" onclick="proceedToCheckout()">
                            üí≥ Finalizar Compra
                        </button>

                        <a href="index.html" class="continue-shopping">
                            ‚Üê Continuar comprando
                        </a>

                        <div class="security-badges">
                            <span class="security-badge">üîí Seguro</span>
                            <span class="security-badge">‚úì Verificado</span>
                            <span class="security-badge">üöö Entrega R√°pida</span>
                    </div>
                    </div>
                        </div>
                    </div>

            <!-- Benefits -->
            <div class="cart-benefits">
                <div class="benefit-card">
                    <div class="benefit-icon">üöö</div>
                    <div class="benefit-title">Entrega R√°pida</div>
                    <div class="benefit-text">Produtos frescos na sua porta</div>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon">üîí</div>
                    <div class="benefit-title">Pagamento Seguro</div>
                    <div class="benefit-text">Seus dados protegidos</div>
        </div>
                <div class="benefit-card">
                    <div class="benefit-icon">üí¨</div>
                    <div class="benefit-title">Suporte</div>
                    <div class="benefit-text">Atendimento dedicado</div>
                </div>
            </div>
        </div>
    </main>

    <!-- API Scripts -->
    <script src="config.js"></script>
    <script src="api-client.js"></script>
    <script src="auth.js"></script>
    
    <script>
        // Carrinho (mesmo key usado no app.js)
        let cart = JSON.parse(localStorage.getItem('freshStoreCart') || '[]');

        // Fun√ß√µes de navega√ß√£o
        function goToHome() {
            window.location.href = 'index.html';
        }

        function goToLogin() {
            window.location.href = 'login.html';
        }

        function handleSearch(query) {
            if (query && query.length > 2) {
                window.location.href = `index.html?search=${encodeURIComponent(query)}`;
            }
        }

        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('overlay');
            menu.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function closeOverlays() {
            document.getElementById('sideMenu')?.classList.remove('open');
            document.getElementById('overlay')?.classList.remove('show');
        }

        // Atualizar UI do usu√°rio logado
        function updateUserUI() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            const loginBtn = document.getElementById('loginBtn');
            
            if (currentUser && loginBtn) {
                const displayName = currentUser.role === 'admin' ? 'Administrador' : currentUser.name || currentUser.username;
                loginBtn.innerHTML = `<span class="login-icon">üë§</span><span class="login-text">${displayName}</span>`;
                loginBtn.onclick = () => window.location.href = currentUser.role === 'admin' ? 'admin.html' : 'cliente.html';
            }
        }

        // Obter pre√ßo efetivo (promocional ou normal)
        function getEffectivePrice(item) {
            return (item.isPromo && item.promoPrice) ? item.promoPrice : item.price;
        }

        // Carregar carrinho
        function loadCart() {
            const badge = document.getElementById('cartBadge');
            const itemsCount = document.getElementById('itemsCount');
            const itemsList = document.getElementById('cartItemsList');
            const emptyCart = document.getElementById('emptyCartPage');
            const cartContent = document.getElementById('cartContent');
            const subtotalEl = document.getElementById('summarySubtotal');
            const totalEl = document.getElementById('summaryTotal');
            const savingsEl = document.getElementById('summarySavings');

            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const subtotal = cart.reduce((sum, item) => sum + (getEffectivePrice(item) * item.quantity), 0);
            const originalTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalSavings = originalTotal - subtotal;

            if (badge) badge.textContent = totalItems;
            if (itemsCount) itemsCount.textContent = totalItems;

            if (cart.length === 0) {
                if (emptyCart) emptyCart.style.display = 'block';
                if (cartContent) cartContent.style.display = 'none';
                return;
            }

            if (emptyCart) emptyCart.style.display = 'none';
            if (cartContent) cartContent.style.display = 'grid';

            // Render items
            if (itemsList) {
                itemsList.innerHTML = cart.map(item => {
                    const effectivePrice = getEffectivePrice(item);
                    const hasPromo = item.isPromo && item.promoPrice;
                    const discountPercent = hasPromo ? Math.round((1 - item.promoPrice / item.price) * 100) : 0;
                    
                    return `
                    <div class="cart-page-item ${hasPromo ? 'has-promo' : ''}">
                        ${hasPromo ? `<div class="item-promo-badge">-${discountPercent}%</div>` : ''}
                        <img src="${item.image}" alt="${item.name}" class="item-image" onerror="this.src='https://via.placeholder.com/90?text=${encodeURIComponent(item.name)}'">
                        <div class="item-info">
                            <div class="item-top">
                                <div>
                                    <div class="item-name">
                                        ${item.name}
                                        ${hasPromo ? '<span class="promo-tag">üî• Promo</span>' : ''}
                                    </div>
                                    <div class="item-unit-price">
                                        ${hasPromo ? `<s class="original-price">R$ ${item.price.toFixed(2)}</s> ` : ''}
                                        <span class="${hasPromo ? 'promo-price' : ''}">R$ ${effectivePrice.toFixed(2)}</span> / ${item.unit}
                                    </div>
                                </div>
                                <button class="item-remove-btn" onclick="removeItem('${item.id}')" title="Remover">üóëÔ∏è</button>
                            </div>
                            <div class="item-bottom">
                                <div class="quantity-selector">
                                    <button class="qty-btn" onclick="updateQty('${item.id}', -1)">‚àí</button>
                                    <span class="qty-value">${item.quantity}</span>
                                    <button class="qty-btn" onclick="updateQty('${item.id}', 1)">+</button>
                                </div>
                                <div class="item-total-price ${hasPromo ? 'promo-total' : ''}">
                                    ${hasPromo ? `<s class="original-total">R$ ${(item.price * item.quantity).toFixed(2)}</s><br>` : ''}
                                    R$ ${(effectivePrice * item.quantity).toFixed(2)}
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');
            }

            // Update totals
            if (subtotalEl) subtotalEl.textContent = `R$ ${subtotal.toFixed(2)}`;
            if (totalEl) totalEl.textContent = `R$ ${subtotal.toFixed(2)}`;
            
            // Mostrar economia se houver
            if (savingsEl) {
                if (totalSavings > 0) {
                    savingsEl.innerHTML = `üéâ Voc√™ economiza: <strong>R$ ${totalSavings.toFixed(2)}</strong>`;
                    savingsEl.style.display = 'block';
                } else {
                    savingsEl.style.display = 'none';
                }
            }
        }

        // Rastrear itens com remo√ß√£o pendente (segundo clique remove)
        const pendingRemoval = {};

        // Atualizar quantidade
        function updateQty(productId, delta) {
            const item = cart.find(i => String(i.id) === String(productId));
            if (!item) return;

            const minOrder = item.minOrder || 1;
            const newQty = item.quantity + delta;
            
            // Verificar se est√° tentando diminuir abaixo do m√≠nimo
            if (newQty < minOrder) {
                // Se j√° foi alertado, remove o item
                if (pendingRemoval[productId]) {
                    delete pendingRemoval[productId];
                    removeItem(productId);
                    return;
                }
                
                // Primeiro alerta - marcar como pendente
                pendingRemoval[productId] = true;
                showToast(`Quantidade m√≠nima: ${minOrder} ${item.unit}. Clique novamente para remover.`, '‚ö†Ô∏è');
                
                // Limpar o pendingRemoval ap√≥s 3 segundos
                setTimeout(() => {
                    delete pendingRemoval[productId];
                }, 3000);
                return;
            }

            // Verificar estoque
            if (newQty > item.stock) {
                showToast('Estoque insuficiente', '‚ùå');
                return;
            }

            // Limpar pending se existir
            delete pendingRemoval[productId];
            
            item.quantity = newQty;
            saveCart();
            loadCart();
        }

        // Remover item
        function removeItem(productId) {
            cart = cart.filter(item => String(item.id) !== String(productId));
            saveCart();
            loadCart();
            showToast('Produto removido', 'üóëÔ∏è');
        }

        // Limpar carrinho
        function clearCart() {
            if (confirm('Tem certeza que deseja limpar o carrinho?')) {
                cart = [];
                saveCart();
                loadCart();
                showToast('Carrinho limpo', 'üóëÔ∏è');
            }
        }

        // Salvar carrinho (mesmo key usado no app.js)
        function saveCart() {
            localStorage.setItem('freshStoreCart', JSON.stringify(cart));
        }

        // Calcular frete
        function calculateShipping() {
            const cep = document.getElementById('cepInput')?.value;
            if (!cep || cep.length < 8) {
                alert('Digite um CEP v√°lido');
                return;
            }
            
            // Simular c√°lculo
            const shippingEl = document.getElementById('summaryShipping');
            if (shippingEl) {
                shippingEl.textContent = 'R$ 15,00';
                shippingEl.style.color = 'var(--primary)';
            }
            
            showToast('Frete calculado!', 'üöö');
        }

        // Ir para checkout
        function proceedToCheckout() {
            if (cart.length === 0) {
                alert('Adicione produtos ao carrinho');
                return;
            }
            // Aqui voc√™ pode redirecionar para uma p√°gina de checkout
            alert('Funcionalidade de checkout em desenvolvimento!');
        }

        // Toast notification
        function showToast(message, icon = '‚úì') {
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
            document.body.appendChild(toast);

            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 2500);
        }

        // M√°scara CEP
        document.getElementById('cepInput')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.slice(0, 5) + '-' + value.slice(5, 8);
            }
            e.target.value = value;
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar se usu√°rio est√° logado
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (!currentUser) {
                window.location.replace('login.html');
                return;
            }
            
            // Verificar status de aprova√ß√£o - bloquear pendentes e suspensos
            if (currentUser.role !== 'admin' && currentUser.role !== 'consultor') {
                if (currentUser.approval_status === 'pending' || currentUser.approval_status === 'suspended') {
                    window.location.replace('index.html');
                    return;
                }
            }
            
            loadCart();
            updateUserUI();
        });
    </script>
</body>
</html>
