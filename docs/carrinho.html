<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrinho - Da Horta Distribuidor</title>
    <link rel="icon" type="image/png" href="images/icone-tomate-dahorta.png">
    <meta name="description" content="Finalize seu pedido de produtos frescos">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* ========== CART PAGE STYLES ========== */
        .cart-page-wrapper {
            min-height: calc(100vh - 200px);
            background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
            padding: 2rem 1rem;
        }

        .cart-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Progress Steps */
        .checkout-progress {
            display: flex;
            justify-content: center;
            margin-bottom: 2.5rem;
            padding: 0 1rem;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-400);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .progress-step.active {
            color: var(--primary);
        }

        .progress-step.completed {
            color: var(--primary);
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .progress-step.active .step-number {
            background: var(--primary);
            color: white;
        }

        .progress-step.completed .step-number {
            background: var(--primary);
            color: white;
        }

        .progress-line {
            width: 60px;
            height: 3px;
            background: var(--gray-200);
            margin: 0 1rem;
        }

        .progress-line.completed {
            background: var(--primary);
        }

        /* Page Title */
        .cart-page-title {
            text-align: center;
            margin-bottom: 2rem;
        }

        .cart-page-title h1 {
            font-size: 2rem;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .cart-page-title p {
            color: var(--gray-500);
        }

        /* Main Grid */
        .cart-main-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 2rem;
            align-items: start;
        }

        @media (max-width: 968px) {
            .cart-main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Items Section */
        .cart-items-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            overflow: hidden;
        }

        .cart-items-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-items-header h2 {
            font-size: 1.1rem;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .items-count {
            background: var(--primary);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .clear-cart-btn {
            color: var(--gray-500);
            background: none;
            border: none;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: color 0.2s;
        }

        .clear-cart-btn:hover {
            color: #ef4444;
        }

        /* Cart Item */
        .cart-page-item {
            display: flex;
            gap: 1rem;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            transition: background 0.2s;
        }

        .cart-page-item:hover {
            background: rgba(34, 197, 94, 0.02);
        }

        .cart-page-item:last-child {
            border-bottom: none;
        }

        /* √öltimo item promocional deve ter border-radius inferior arredondado */
        .cart-page-item.has-promo:last-child {
            border-bottom-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
        }

        .item-image {
            width: 90px;
            height: 90px;
            border-radius: 0.75rem;
            object-fit: cover;
            background: var(--gray-100);
            flex-shrink: 0;
        }

        .item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .item-top {
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .item-name {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 1rem;
        }

        .item-unit-price {
            font-size: 0.85rem;
            color: var(--gray-500);
            white-space: nowrap;
        }

        .item-remove-btn {
            background: none;
            border: none;
            color: var(--gray-400);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.25rem;
            transition: all 0.2s;
        }

        .item-remove-btn:hover {
            color: #ef4444;
            transform: scale(1.1);
        }

        .item-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--gray-100);
            border-radius: 2rem;
            padding: 0.25rem;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: white;
            color: var(--gray-700);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:hover {
            background: var(--primary);
            color: white;
        }

        .qty-value {
            min-width: 32px;
            text-align: center;
            font-weight: 600;
        }

        .qty-input {
            width: 60px;
            padding: 6px 8px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            background: white;
            color: var(--gray-800);
            -moz-appearance: textfield;
        }

        .qty-input::-webkit-outer-spin-button,
        .qty-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .qty-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
            font-size: 1rem;
        }

        .item-total-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            white-space: nowrap;
            text-align: right;
        }

        /* Empty Cart */
        .empty-cart-container {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-cart-icon {
            font-size: 5rem;
            opacity: 0.3;
            margin-bottom: 1.5rem;
        }

        .empty-cart-container h2 {
            font-size: 1.5rem;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .empty-cart-container p {
            color: var(--gray-500);
            margin-bottom: 1.5rem;
        }

        .empty-cart-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary);
            color: white;
            padding: 0.875rem 1.5rem;
            border-radius: 2rem;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }

        .empty-cart-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Summary Card */
        .summary-card-modern {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: sticky;
            top: 1rem;
            overflow: hidden;
        }

        .summary-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.25rem 1.5rem;
        }

        .summary-header h2 {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-body {
            padding: 1.5rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            font-size: 0.95rem;
            color: var(--gray-600);
            white-space: nowrap;
        }

        .summary-row.total {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--gray-900);
            border-top: 2px dashed var(--gray-200);
            margin-top: 0.5rem;
            white-space: nowrap;
            padding-top: 1rem;
        }

        .summary-row.total span:last-child {
            color: var(--primary);
        }

        .promo-code-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-100);
        }

        .promo-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .promo-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }

        .promo-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .promo-btn {
            padding: 0.75rem 1rem;
            background: var(--gray-100);
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .promo-btn:hover {
            background: var(--gray-200);
        }

        .checkout-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .continue-shopping {
            display: block;
            text-align: center;
            margin-top: 1rem;
            color: var(--gray-500);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .continue-shopping:hover {
            color: var(--primary);
        }

        .security-badges {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-100);
        }

        .security-badge {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Shipping Estimate */
        .shipping-estimate {
            background: rgba(34, 197, 94, 0.08);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .shipping-estimate-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cep-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .cep-input {
            flex: 1;
            padding: 0.625rem 0.875rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }

        .cep-btn {
            padding: 0.625rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cep-btn:hover {
            background: var(--primary-dark);
        }

        /* Benefits */
        .cart-benefits {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        @media (max-width: 768px) {
            .cart-benefits {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
                margin-top: 1rem;
            }
        }

        .benefit-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.04);
        }

        @media (max-width: 768px) {
            .benefit-card {
                padding: 0.75rem 0.5rem;
                border-radius: 0.75rem;
            }
        }

        .benefit-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        @media (max-width: 768px) {
            .benefit-icon {
                font-size: 1.5rem;
                margin-bottom: 0.35rem;
            }
        }

        .benefit-title {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        @media (max-width: 768px) {
            .benefit-title {
                font-size: 0.65rem;
                margin-bottom: 0.15rem;
            }
        }

        .benefit-text {
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        @media (max-width: 768px) {
            .benefit-text {
                font-size: 0.55rem;
            }
        }

        /* Promo styles for cart page */
        .cart-page-item.has-promo {
            position: relative;
            background: linear-gradient(135deg, #f0fdf4, #ffffff);
            border: 3px solid #22c55e;
        }

        .item-promo-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.688rem;
            font-weight: 700;
            z-index: 5;
        }

        .item-name .promo-tag {
            display: inline-block;
            background: #22c55e;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.625rem;
            font-weight: 600;
            margin-left: 6px;
            vertical-align: middle;
        }

        .item-unit-price .original-price,
        .item-total-price .original-total {
            color: #9ca3af;
            font-size: 0.813rem;
        }

        .item-unit-price .promo-price {
            color: #22c55e;
            font-weight: 600;
        }

        .item-total-price.promo-total {
            color: #22c55e;
        }

        .summary-savings {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #166534;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .summary-savings strong {
            color: #15803d;
        }
    </style>
</head>
<body>
    <!-- Banner Header -->
    <div class="banner-header" onclick="goToHome()" style="cursor: pointer;" title="Clique para voltar √† home">
        <picture>
            <source media="(max-width: 768px)" srcset="images/header_da_horta_mobile.png">
            <img src="images/Header_da_horta.png" alt="Da Horta Distribuidor" class="banner-image">
        </picture>
    </div>

    <!-- Navigation Header -->
    <header class="header">
        <div class="container">
            <!-- Estado Normal -->
            <div class="header-content" id="headerNormal">
                <div class="header-left">
                    <button class="hamburger-btn" onclick="toggleMenu()" aria-label="Menu">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <a href="index.html" class="continue-shopping-btn">
                        ‚Üê Continuar Comprando
                    </a>
                </div>
                
                <div class="header-actions">
                    <button class="search-btn-icon" onclick="toggleSearchMode()" title="Buscar produtos">
                        üîç
                    </button>
                    <a href="carrinho.html" class="cart-btn active">
                        üõí Carrinho <span class="cart-badge" id="cartBadge">0</span>
                    </a>
                </div>
            </div>
            
            <!-- Estado de Busca -->
            <div class="header-content header-search-mode" id="headerSearch" style="display: none;">
                <div class="header-left">
                    <button class="back-btn" onclick="toggleSearchMode()" title="Voltar">
                        ‚Üê Voltar
                    </button>
                </div>
                
                <div class="header-actions" style="flex: 1;">
                    <div class="search-container" style="flex: 1; max-width: none;">
                        <input 
                            type="text" 
                            id="searchInputCart" 
                            class="search-input" 
                            placeholder="Filtrar itens do carrinho..."
                            oninput="handleSearchCart(event)">
                        <span class="search-icon">üîç</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Side Menu -->
    <nav class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h3>Menu</h3>
            <button class="close-menu-btn" onclick="toggleMenu()">‚úï</button>
        </div>
        <div class="side-menu-content">
            <ul class="menu-list">
                <li><a href="index.html">üè† In√≠cio</a></li>
                <li><a href="carrinho.html" class="active">üõí Carrinho</a></li>
                <li><a href="cliente.html">üì¶ Meus Pedidos</a></li>
                <li class="menu-divider"></li>
                <li><a href="login.html">üîê Entrar</a></li>
            </ul>
        </div>
    </nav>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="closeOverlays()"></div>

    <!-- Main Content -->
    <main class="cart-page-wrapper">
        <div class="cart-container">
            <!-- Progress Steps -->
            <div class="checkout-progress">
                <div class="progress-step active">
                    <span class="step-number">1</span>
                    <span>Carrinho</span>
        </div>
                <div class="progress-line"></div>
                <div class="progress-step">
                    <span class="step-number">2</span>
                    <span>Dados</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step">
                    <span class="step-number">3</span>
                    <span>Pagamento</span>
                </div>
            </div>

            <!-- Page Title -->
            <div class="cart-page-title">
                <h1>üõí Meu Carrinho</h1>
                <p>Revise seus produtos antes de continuar</p>
                    </div>
                    
            <!-- Empty Cart -->
            <div class="empty-cart-container" id="emptyCartPage" style="display: none;">
                <div class="empty-cart-icon">üõí</div>
                <h2>Seu carrinho est√° vazio</h2>
                <p>Explore nossos produtos frescos e adicione ao carrinho</p>
                <a href="index.html" class="empty-cart-btn">
                    ü•¨ Ver Produtos
                </a>
                    </div>

            <!-- Cart Content -->
            <div class="cart-main-grid" id="cartContent">
                <!-- Items Section -->
                <div class="cart-items-card">
                    <div class="cart-items-header">
                        <h2>
                            üì¶ Itens do Pedido
                            <span class="items-count" id="itemsCount">0</span>
                        </h2>
                        <button class="clear-cart-btn" onclick="clearCart()">
                            üóëÔ∏è Limpar
                        </button>
                    </div>
                    <div id="cartItemsList">
                        <!-- Items rendered by JS -->
                    </div>
                </div>

                <!-- Summary Section -->
                <div class="summary-card-modern">
                    <div class="summary-header">
                        <h2>üìã Resumo do Pedido</h2>
                    </div>
                    <div class="summary-body">
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span id="summarySubtotal">R$ 0,00</span>
                        </div>
                        <div class="summary-row">
                            <span>Frete</span>
                            <span id="summaryShipping">Calcular</span>
                        </div>
                        <div id="summarySavings" class="summary-savings" style="display: none;"></div>
                        <div class="summary-row total">
                            <span>Total</span>
                            <span id="summaryTotal">R$ 0,00</span>
                    </div>

                        <!-- Shipping Estimate -->
                        <div class="shipping-estimate">
                            <div class="shipping-estimate-title">
                                üöö Calcular Frete
                            </div>
                            <div class="cep-input-group">
                                <input type="text" class="cep-input" id="cepInput" placeholder="00000-000" maxlength="9">
                                <button class="cep-btn" onclick="calculateShipping()">OK</button>
                            </div>
                        </div>

                        <!-- Promo Code -->
                        <div class="promo-code-section">
                            <div class="promo-input-group">
                                <input type="text" class="promo-input" placeholder="Cupom de desconto">
                                <button class="promo-btn">Aplicar</button>
                    </div>
                </div>

                        <button class="checkout-btn" onclick="proceedToCheckout()">
                            üí≥ Finalizar Compra
                        </button>

                        <a href="index.html" class="continue-shopping">
                            ‚Üê Continuar comprando
                        </a>

                        <div class="security-badges">
                            <span class="security-badge">üîí Seguro</span>
                            <span class="security-badge">‚úì Verificado</span>
                            <span class="security-badge">üöö Entrega R√°pida</span>
                    </div>
                    </div>
                        </div>
                    </div>

            <!-- Benefits -->
            <div class="cart-benefits">
                <div class="benefit-card">
                    <div class="benefit-icon">üöö</div>
                    <div class="benefit-title">Entrega R√°pida</div>
                    <div class="benefit-text">Produtos frescos na sua porta</div>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon">üîí</div>
                    <div class="benefit-title">Pagamento Seguro</div>
                    <div class="benefit-text">Seus dados protegidos</div>
        </div>
                <div class="benefit-card">
                    <div class="benefit-icon">üí¨</div>
                    <div class="benefit-title">Suporte</div>
                    <div class="benefit-text">Atendimento dedicado</div>
                </div>
            </div>
        </div>
    </main>

    <!-- API Scripts -->
    <script src="config.js"></script>
    <script src="api-client.js"></script>
    <script src="auth.js"></script>
    
    <script>
        // Fun√ß√£o para carregar carrinho do backend (sess√£o)
        async function loadCartFromStorage() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (!currentUser) {
                console.warn('‚ö†Ô∏è Tentativa de carregar carrinho sem usu√°rio logado');
                cart = [];
                return;
            }
            
            try {
                // Tentar carregar do backend primeiro (sess√£o atual)
                const response = await api.getCart();
                if (response && response.items && response.items.length > 0) {
                    cart = response.items;
                    console.log('üì¶ Carrinho carregado do backend (carrinho.html):', cart.length, 'itens');
                    
                    // Salvar em m√∫ltiplos lugares
                    sessionStorage.setItem('freshStoreCart', JSON.stringify(cart));
                    const cartKey = `user_cart_${currentUser.id}`;
                    localStorage.setItem(cartKey, JSON.stringify(cart));
                } else {
                    // Se n√£o h√° carrinho no backend, tentar carregar do localStorage
                    const cartKey = `user_cart_${currentUser.id}`;
                    const savedCart = localStorage.getItem(cartKey);
                    
                    if (savedCart) {
                        cart = JSON.parse(savedCart);
                        console.log('üì¶ Carrinho restaurado do localStorage (sess√£o anterior):', cart.length, 'itens');
                        
                        // Sincronizar com backend (nova sess√£o)
                        await saveCart();
                    } else {
                        cart = [];
                        console.log('üõí Carrinho vazio - iniciando novo carrinho (carrinho.html)');
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao carregar carrinho do backend, tentando localStorage:', error);
                
                // Fallback: carregar do localStorage
                try {
                    const cartKey = `user_cart_${currentUser.id}`;
                    const savedCart = localStorage.getItem(cartKey);
                    
                    if (savedCart) {
                        cart = JSON.parse(savedCart);
                        console.log('üì¶ Carrinho carregado do localStorage (fallback):', cart.length, 'itens');
                        
                        // Tentar sincronizar com backend
                        await saveCart();
                    } else {
                        // √öltimo fallback: sessionStorage
                        const saved = sessionStorage.getItem('freshStoreCart');
                        if (saved) {
                            cart = JSON.parse(saved);
                            console.log('üì¶ Carrinho carregado do sessionStorage (fallback):', cart.length, 'itens');
                        } else {
                            cart = [];
                            console.log('üõí Carrinho vazio - iniciando novo carrinho');
                        }
                    }
                } catch (e) {
                    console.error('‚ùå Erro ao carregar carrinho localmente:', e);
                    cart = [];
                }
            }
        }
        
        // Fun√ß√£o para carregar carrinho da sess√£o (s√≠ncrona - para inicializa√ß√£o)
        function getCartFromSession() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (!currentUser) {
                return [];
            }
            
            try {
                const saved = sessionStorage.getItem('freshStoreCart');
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar carrinho:', error);
            }
            return [];
        }
        
        // Carrinho inicial (ser√° atualizado quando loadCartFromStorage() for chamado)
        let cart = getCartFromSession();

        // ==================== FORMATA√á√ÉO DE MOEDA ====================
        // Formata valor para moeda brasileira (R$ 999.999,99)
        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) return 'R$ 0,00';
            return value.toLocaleString('pt-BR', { 
                style: 'currency', 
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Formata apenas o valor num√©rico (999.999,99) sem o R$
        function formatNumber(value) {
            if (value === null || value === undefined || isNaN(value)) return '0,00';
            return value.toLocaleString('pt-BR', { 
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Fun√ß√µes de navega√ß√£o
        function goToHome() {
            window.location.href = 'index.html';
        }

        function goToLogin() {
            window.location.href = 'login.html';
        }

        function handleSearch(query) {
            if (query && query.length > 2) {
                window.location.href = `index.html?search=${encodeURIComponent(query)}`;
            }
        }
        
        // Toggle modo de busca no header
        function toggleSearchMode() {
            const headerNormal = document.getElementById('headerNormal');
            const headerSearch = document.getElementById('headerSearch');
            const searchInput = document.getElementById('searchInputCart');
            
            if (headerNormal.style.display === 'none') {
                // Voltar ao modo normal
                headerNormal.style.display = 'flex';
                headerSearch.style.display = 'none';
                // Limpar busca e mostrar todos os itens
                searchInput.value = '';
                filterCartItems('');
            } else {
                // Entrar no modo de busca
                headerNormal.style.display = 'none';
                headerSearch.style.display = 'flex';
                // Focar no input de busca
                setTimeout(() => searchInput.focus(), 100);
            }
        }
        
        // Filtrar itens do carrinho pela busca
        function filterCartItems(query) {
            const items = document.querySelectorAll('.cart-page-item');
            const searchTerm = query.toLowerCase().trim();
            
            items.forEach(item => {
                const itemName = item.querySelector('.item-name')?.textContent.toLowerCase() || '';
                if (!searchTerm || itemName.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Handler de busca do carrinho (filtra itens em tempo real)
        function handleSearchCart(event) {
            const query = event.target.value;
            filterCartItems(query);
        }

        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('overlay');
            menu.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function closeOverlays() {
            document.getElementById('sideMenu')?.classList.remove('open');
            document.getElementById('overlay')?.classList.remove('show');
        }

        // Atualizar UI do usu√°rio logado
        function updateUserUI() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            const loginBtn = document.getElementById('loginBtn');
            
            if (currentUser && loginBtn) {
                const displayName = currentUser.role === 'admin' ? 'Administrador' : currentUser.name || currentUser.username;
                loginBtn.innerHTML = `<span class="login-icon">üë§</span><span class="login-text">${displayName}</span>`;
                loginBtn.onclick = () => window.location.href = currentUser.role === 'admin' ? 'admin.html' : 'cliente.html';
            }
        }

        // Obter pre√ßo efetivo (promocional ou normal)
        function getEffectivePrice(item) {
            return (item.isPromo && item.promoPrice) ? item.promoPrice : item.price;
        }

        // Carregar carrinho
        async function loadCart() {
            // Recarregar carrinho do backend antes de renderizar
            await loadCartFromStorage();
            
            const badge = document.getElementById('cartBadge');
            const itemsCount = document.getElementById('itemsCount');
            const itemsList = document.getElementById('cartItemsList');
            const emptyCart = document.getElementById('emptyCartPage');
            const cartContent = document.getElementById('cartContent');
            const subtotalEl = document.getElementById('summarySubtotal');
            const totalEl = document.getElementById('summaryTotal');
            const savingsEl = document.getElementById('summarySavings');

            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const subtotal = cart.reduce((sum, item) => sum + (getEffectivePrice(item) * item.quantity), 0);
            const originalTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalSavings = originalTotal - subtotal;

            if (badge) badge.textContent = totalItems;
            if (itemsCount) itemsCount.textContent = totalItems;

            if (cart.length === 0) {
                if (emptyCart) emptyCart.style.display = 'block';
                if (cartContent) cartContent.style.display = 'none';
                return;
            }

            if (emptyCart) emptyCart.style.display = 'none';
            if (cartContent) cartContent.style.display = 'grid';

            // Render items
            if (itemsList) {
                itemsList.innerHTML = cart.map(item => {
                    const effectivePrice = getEffectivePrice(item);
                    const hasPromo = item.isPromo && item.promoPrice;
                    const discountPercent = hasPromo ? Math.round((1 - item.promoPrice / item.price) * 100) : 0;
                    
                    return `
                    <div class="cart-page-item ${hasPromo ? 'has-promo' : ''}">
                        ${hasPromo ? `<div class="item-promo-badge">-${discountPercent}%</div>` : ''}
                        <img src="${item.image}" alt="${item.name}" class="item-image" onerror="this.src='https://via.placeholder.com/90?text=${encodeURIComponent(item.name)}'">
                        <div class="item-info">
                            <div class="item-top">
                                <div>
                                    <div class="item-name">
                                        ${item.name}
                                        ${hasPromo ? '<span class="promo-tag">üî• Promo</span>' : ''}
                                    </div>
                                    <div class="item-unit-price">
                                        ${hasPromo ? `<s class="original-price">${formatCurrency(item.price)}</s> ` : ''}
                                        <span class="${hasPromo ? 'promo-price' : ''}">${formatCurrency(effectivePrice)}</span> / ${item.unit}
                                    </div>
                                </div>
                                <button class="item-remove-btn" onclick="removeItem('${item.id}')" title="Remover">üóëÔ∏è</button>
                            </div>
                            <div class="item-bottom">
                                <div class="quantity-selector">
                                    <button class="qty-btn" onclick="updateQty('${item.id}', -${item.minOrder || 1})">‚àí</button>
                                    <input type="number"
                                           step="any"
                                           class="qty-input"
                                           value="${item.quantity}"
                                           min="${item.minOrder || 1}"
                                           data-product-id="${item.id}"
                                           data-min-order="${item.minOrder || 1}"
                                           data-product-name="${item.name}"
                                           data-product-unit="${item.unit || 'un'}"
                                           onchange="validateQtyInput(this)"
                                           onkeypress="if(event.key==='Enter'){this.blur();}">
                                    <button class="qty-btn" onclick="updateQty('${item.id}', ${item.minOrder || 1})">+</button>
                                </div>
                                <div class="item-total-price ${hasPromo ? 'promo-total' : ''}">
                                    ${hasPromo ? `<s class="original-total">${formatCurrency(item.price * item.quantity)}</s><br>` : ''}
                                    ${formatCurrency(effectivePrice * item.quantity)}
                            </div>
                        </div>
                    </div>
                    </div>
                `}).join('');
            }

            // Update totals
            if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
            if (totalEl) totalEl.textContent = formatCurrency(subtotal);
            
            // Mostrar economia se houver
            if (savingsEl) {
                if (totalSavings > 0) {
                    savingsEl.innerHTML = `üéâ Voc√™ economiza: <strong>${formatCurrency(totalSavings)}</strong>`;
                    savingsEl.style.display = 'block';
                } else {
                    savingsEl.style.display = 'none';
                }
            }
        }

        // Rastrear itens com remo√ß√£o pendente (segundo clique remove)
        const pendingRemoval = {};

        // Atualizar quantidade
        function updateQty(productId, delta) {
            const item = cart.find(i => String(i.id) === String(productId));
            if (!item) return;

            const minOrder = item.minOrder || 1;
            const newQty = item.quantity + delta;
            
            // Verificar se est√° tentando diminuir abaixo do m√≠nimo
            if (newQty < minOrder) {
                // Se j√° foi alertado, remove o item
                if (pendingRemoval[productId]) {
                    delete pendingRemoval[productId];
                    removeItem(productId);
                    return;
                }
                
                // Primeiro alerta - marcar como pendente
                pendingRemoval[productId] = true;
                showToast(`Quantidade m√≠nima: ${minOrder} ${item.unit}. Clique novamente para remover.`, '‚ö†Ô∏è');
                
                // Limpar o pendingRemoval ap√≥s 3 segundos
                setTimeout(() => {
                    delete pendingRemoval[productId];
                }, 3000);
                return;
            }

            // Verificar estoque
            if (newQty > item.stock) {
                showToast('Estoque insuficiente', '‚ùå');
                return;
            }

            // Limpar pending se existir
            delete pendingRemoval[productId];
            
            item.quantity = newQty;
            saveCart().then(() => loadCart());
        }

        // Validar quantidade digitada no input
        function validateQtyInput(input) {
            const productId = input.dataset.productId;
            const minOrder = parseFloat(input.dataset.minOrder) || 1;
            const productName = input.dataset.productName || 'Produto';
            const productUnit = input.dataset.productUnit || 'un';
            let newQty = parseFloat(input.value) || minOrder;
            
            const item = cart.find(i => String(i.id) === String(productId));
            if (!item) return;
            
            // Validar m√≠nimo
            if (newQty < minOrder) {
                showToast(`Quantidade m√≠nima para "${productName}" √© ${minOrder} ${productUnit}. Ajustando automaticamente.`, '‚ö†Ô∏è');
                newQty = minOrder;
                input.value = minOrder;
            }
            
            // Validar estoque
            if (newQty > item.stock) {
                showToast(`Estoque insuficiente. M√°ximo: ${item.stock} ${productUnit}`, '‚ùå');
                newQty = item.stock;
                input.value = item.stock;
            }
            
            // Atualizar quantidade
            item.quantity = newQty;
            saveCart().then(() => loadCart());
        }

        // Remover item
        async function removeItem(productId) {
            cart = cart.filter(item => String(item.id) !== String(productId));
            await saveCart();
            await loadCart();
            showToast('Produto removido', 'üóëÔ∏è');
        }

        // Limpar carrinho
        async function clearCart() {
            if (confirm('Tem certeza que deseja limpar o carrinho?')) {
                cart = [];
                await saveCart();
                await loadCart();
                showToast('Carrinho limpo', 'üóëÔ∏è');
            }
        }

        // Salvar carrinho (vinculado √† sess√£o)
        async function saveCart() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (!currentUser) {
                console.warn('‚ö†Ô∏è Tentativa de salvar carrinho sem usu√°rio logado');
                return;
            }
            
            try {
                await api.saveCart(cart);
                console.log('üíæ Carrinho salvo no backend (carrinho.html):', cart.length, 'itens');
                
                // Salvar em m√∫ltiplos lugares para garantir persist√™ncia
                sessionStorage.setItem('freshStoreCart', JSON.stringify(cart));
                
                // Salvar no localStorage vinculado ao usu√°rio (para preservar entre sess√µes)
                const cartKey = `user_cart_${currentUser.id}`;
                localStorage.setItem(cartKey, JSON.stringify(cart));
            } catch (error) {
                console.error('‚ùå Erro ao salvar carrinho no backend:', error);
                // Fallback: salvar localmente
                try {
                    sessionStorage.setItem('freshStoreCart', JSON.stringify(cart));
                    const cartKey = `user_cart_${currentUser.id}`;
                    localStorage.setItem(cartKey, JSON.stringify(cart));
                    console.log('üíæ Carrinho salvo localmente (fallback)');
                } catch (e) {
                    console.error('‚ùå Erro ao salvar carrinho localmente:', e);
                }
            }
        }

        // Calcular frete
        function calculateShipping() {
            const cep = document.getElementById('cepInput')?.value;
            if (!cep || cep.length < 8) {
                alert('Digite um CEP v√°lido');
                return;
            }
            
            // Simular c√°lculo
            const shippingEl = document.getElementById('summaryShipping');
            if (shippingEl) {
                shippingEl.textContent = 'R$ 15,00';
                shippingEl.style.color = 'var(--primary)';
            }
            
            showToast('Frete calculado!', 'üöö');
        }

        // Ir para checkout
        function proceedToCheckout() {
            if (cart.length === 0) {
                alert('Adicione produtos ao carrinho');
                return;
            }
            // Redirecionar para a p√°gina de checkout
            window.location.href = 'checkout.html';
        }

        // Toast notification
        function showToast(message, icon = '‚úì') {
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
            document.body.appendChild(toast);

            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 2500);
        }

        // M√°scara CEP
        document.getElementById('cepInput')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.slice(0, 5) + '-' + value.slice(5, 8);
            }
            e.target.value = value;
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar se usu√°rio est√° logado
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (!currentUser) {
                window.location.replace('login.html');
                return;
            }
            
            // Verificar status de aprova√ß√£o - bloquear pendentes e suspensos
            if (currentUser.role !== 'admin' && currentUser.role !== 'consultor') {
                if (currentUser.approval_status === 'pending' || currentUser.approval_status === 'suspended') {
                    window.location.replace('index.html');
                    return;
                }
            }
            
            loadCart().then(() => {
                updateUserUI();
            });
        });
    </script>
</body>
</html>
