<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Pedidos - Da Horta Distribuidora</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Banner Header -->
    <div class="banner-header" onclick="window.location.href='index.html'" style="cursor: pointer;" title="Clique para voltar √† home">
        <img src="images/Header_da_horta.png" alt="Da Horta Distribuidora" class="banner-image">
    </div>

    <!-- Navigation Header -->
    <header class="main-header">
        <div class="header-content">
            <button class="menu-toggle" id="menuToggle" aria-label="Abrir menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <div class="header-actions">
                <button class="search-btn" id="searchBtn" aria-label="Buscar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
                
                <a href="carrinho.html" class="cart-btn" aria-label="Carrinho">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    <span class="cart-badge" id="cartBadge">0</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Side Menu -->
    <nav class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <button class="menu-close" id="menuClose" aria-label="Fechar menu">√ó</button>
        </div>
        <ul class="side-menu-list">
            <li><a href="index.html">üè† In√≠cio</a></li>
            <li><a href="carrinho.html">üõí Carrinho</a></li>
            <li><a href="cliente.html" class="active">üì¶ Meus Pedidos</a></li>
            <li><a href="#" onclick="logout()">üö™ Sair</a></li>
        </ul>
    </nav>

    <!-- Menu Overlay -->
    <div class="menu-overlay" id="menuOverlay"></div>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal">
        <div class="search-modal-content">
            <input type="text" id="searchInput" placeholder="Buscar produtos..." class="search-input">
            <button class="search-close" id="searchClose">√ó</button>
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>

    <!-- Main Content -->
    <main class="container orders-page">
        <div class="page-header">
            <div class="page-title-section">
                <h1>üì¶ Meus Pedidos</h1>
                <p class="page-subtitle">Acompanhe todos os seus pedidos em tempo real</p>
            </div>
            <button class="btn-primary" onclick="window.location.href='index.html'">
                ‚ûï Fazer Novo Pedido
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-info">
                    <span class="stat-label">Pendentes</span>
                    <span class="stat-value" id="statPendentes">0</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-info">
                    <span class="stat-label">Confirmados</span>
                    <span class="stat-value" id="statConfirmados">0</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üöö</div>
                <div class="stat-info">
                    <span class="stat-label">Em Entrega</span>
                    <span class="stat-value" id="statEmEntrega">0</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-info">
                    <span class="stat-label">Total de Pedidos</span>
                    <span class="stat-value" id="statTotal">0</span>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-group">
                <label for="filterStatus">Filtrar por status:</label>
                <select id="filterStatus" class="filter-select" onchange="filterOrders()">
                    <option value="">Todos os Status</option>
                    <option value="pendente">Pendente</option>
                    <option value="confirmado">Confirmado</option>
                    <option value="em_entrega">Em Entrega</option>
                    <option value="entregue">Entregue</option>
                    <option value="cancelado">Cancelado</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="sortBy">Ordenar por:</label>
                <select id="sortBy" class="filter-select" onchange="filterOrders()">
                    <option value="recent">Mais Recentes</option>
                    <option value="oldest">Mais Antigos</option>
                    <option value="value">Maior Valor</option>
                </select>
            </div>
        </div>

        <!-- Orders List -->
        <div class="orders-list" id="ordersList">
            <!-- Loading State -->
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Carregando seus pedidos...</p>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">üì¶</div>
            <h2>Nenhum pedido encontrado</h2>
            <p>Voc√™ ainda n√£o realizou nenhum pedido</p>
            <a href="index.html" class="btn-primary">Come√ßar a Comprar</a>
        </div>
    </main>

    <!-- Order Detail Modal -->
    <div class="modal" id="orderDetailModal">
        <div class="modal-content order-detail">
            <div class="modal-header">
                <h2>Detalhes do Pedido <span id="modalOrderNumber"></span></h2>
                <button class="modal-close" onclick="closeOrderDetail()">√ó</button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- API Scripts -->
    <script src="config.js"></script>
    <script src="api-client.js"></script>
    <script src="auth.js"></script>
    
    <script>
        // Vari√°veis globais
        let allOrders = [];
        let filteredOrders = [];

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üì¶ P√°gina de pedidos carregada');
            
            // Verificar autentica√ß√£o
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (!currentUser) {
                alert('Por favor, fa√ßa login para ver seus pedidos');
                window.location.href = 'login.html';
                return;
            }

            // Menu Toggle
            setupMenu();
            
            // Atualizar badge do carrinho
            updateCartBadge();
            
            // Carregar pedidos
            await loadOrders();
        });

        // Setup Menu
        function setupMenu() {
            const menuToggle = document.getElementById('menuToggle');
            const menuClose = document.getElementById('menuClose');
            const menuOverlay = document.getElementById('menuOverlay');
            const sideMenu = document.getElementById('sideMenu');
            const searchBtn = document.getElementById('searchBtn');
            const searchModal = document.getElementById('searchModal');
            const searchClose = document.getElementById('searchClose');
            const searchInput = document.getElementById('searchInput');

            menuToggle?.addEventListener('click', () => {
                sideMenu?.classList.add('active');
                menuOverlay?.classList.add('active');
            });

            const closeMenu = () => {
                sideMenu?.classList.remove('active');
                menuOverlay?.classList.remove('active');
            };
            menuClose?.addEventListener('click', closeMenu);
            menuOverlay?.addEventListener('click', closeMenu);

            searchBtn?.addEventListener('click', () => {
                searchModal?.classList.add('active');
                searchInput?.focus();
            });

            searchClose?.addEventListener('click', () => {
                searchModal?.classList.remove('active');
            });

            searchModal?.addEventListener('click', (e) => {
                if (e.target === searchModal) {
                    searchModal.classList.remove('active');
                }
            });

            searchInput?.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (query) {
                    window.location.href = `index.html?search=${encodeURIComponent(query)}`;
                }
            });
        }

        // Atualizar badge do carrinho
        function updateCartBadge() {
            const cart = JSON.parse(localStorage.getItem('freshStoreCart')) || [];
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cartBadge');
            if (badge) {
                badge.textContent = totalItems;
            }
        }

        // Carregar pedidos
        async function loadOrders() {
            const ordersList = document.getElementById('ordersList');
            const emptyState = document.getElementById('emptyState');
            
            try {
                const response = await api.getMyOrders();
                allOrders = response || [];
                filteredOrders = [...allOrders];
                
                console.log(`üì¶ ${allOrders.length} pedidos carregados`);
                
                if (allOrders.length === 0) {
                    ordersList.style.display = 'none';
                    emptyState.style.display = 'flex';
                } else {
                    ordersList.style.display = 'grid';
                    emptyState.style.display = 'none';
                    updateStats();
                    renderOrders();
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar pedidos:', error);
                ordersList.innerHTML = `
                    <div class="error-state">
                        <div class="error-icon">‚ö†Ô∏è</div>
                        <h2>Erro ao carregar pedidos</h2>
                        <p>${error.message || 'Tente novamente mais tarde'}</p>
                        <button class="btn-primary" onclick="loadOrders()">Tentar Novamente</button>
                    </div>
                `;
            }
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            const pendentes = allOrders.filter(o => o.status === 'pendente').length;
            const confirmados = allOrders.filter(o => o.status === 'confirmado').length;
            const emEntrega = allOrders.filter(o => o.status === 'em_entrega').length;
            
            document.getElementById('statPendentes').textContent = pendentes;
            document.getElementById('statConfirmados').textContent = confirmados;
            document.getElementById('statEmEntrega').textContent = emEntrega;
            document.getElementById('statTotal').textContent = allOrders.length;
        }

        // Renderizar pedidos
        function renderOrders() {
            const ordersList = document.getElementById('ordersList');
            
            if (filteredOrders.length === 0) {
                ordersList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <h2>Nenhum pedido encontrado</h2>
                        <p>Tente ajustar os filtros</p>
                    </div>
                `;
                return;
            }
            
            ordersList.innerHTML = filteredOrders.map(order => createOrderCard(order)).join('');
        }

        // Criar card de pedido
        function createOrderCard(order) {
            const statusConfig = {
                'pendente': { label: 'Pendente', icon: '‚è≥', class: 'pending' },
                'confirmado': { label: 'Confirmado', icon: '‚úÖ', class: 'confirmed' },
                'em_entrega': { label: 'Em Entrega', icon: 'üöö', class: 'delivering' },
                'entregue': { label: 'Entregue', icon: 'üì¶', class: 'delivered' },
                'cancelado': { label: 'Cancelado', icon: '‚ùå', class: 'cancelled' }
            };
            
            const status = statusConfig[order.status] || statusConfig['pendente'];
            const total = order.total_amount || 0;
            const date = new Date(order.created_at).toLocaleDateString('pt-BR');
            const itemCount = order.items?.length || 0;
            
            return `
                <div class="order-card" onclick="viewOrderDetail('${order.id}')">
                    <div class="order-card-header">
                        <div class="order-number">
                            <strong>Pedido #${order.order_number}</strong>
                            <span class="order-date">üìÖ ${date}</span>
                        </div>
                        <span class="status-badge ${status.class}">
                            ${status.icon} ${status.label}
                        </span>
                    </div>
                    
                    <div class="order-card-body">
                        <div class="order-info-row">
                            <span class="order-info-label">Items:</span>
                            <span class="order-info-value">${itemCount} produtos</span>
                        </div>
                        <div class="order-info-row">
                            <span class="order-info-label">Entrega:</span>
                            <span class="order-info-value">${order.shipping_address?.city || '-'}, ${order.shipping_address?.state || '-'}</span>
                        </div>
                        <div class="order-info-row">
                            <span class="order-info-label">Pagamento:</span>
                            <span class="order-info-value">${formatPaymentMethod(order.payment_method)}</span>
                        </div>
                    </div>
                    
                    <div class="order-card-footer">
                        <span class="order-total">Total: ${formatMoney(total)}</span>
                        <button class="btn-view-details" onclick="event.stopPropagation(); viewOrderDetail('${order.id}')">
                            Ver Detalhes ‚Üí
                        </button>
                    </div>
                </div>
            `;
        }

        // Filtrar pedidos
        function filterOrders() {
            const statusFilter = document.getElementById('filterStatus').value;
            const sortBy = document.getElementById('sortBy').value;
            
            // Filtrar por status
            filteredOrders = statusFilter 
                ? allOrders.filter(o => o.status === statusFilter)
                : [...allOrders];
            
            // Ordenar
            if (sortBy === 'recent') {
                filteredOrders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            } else if (sortBy === 'oldest') {
                filteredOrders.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            } else if (sortBy === 'value') {
                filteredOrders.sort((a, b) => (b.total_amount || 0) - (a.total_amount || 0));
            }
            
            renderOrders();
        }

        // Ver detalhes do pedido
        async function viewOrderDetail(orderId) {
            const modal = document.getElementById('orderDetailModal');
            const content = document.getElementById('orderDetailContent');
            const orderNumber = document.getElementById('modalOrderNumber');
            
            try {
                const order = await api.getOrderById(orderId);
                
                orderNumber.textContent = `#${order.order_number}`;
                content.innerHTML = createOrderDetailContent(order);
                modal.classList.add('active');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar detalhes:', error);
                alert('Erro ao carregar detalhes do pedido');
            }
        }

        // Criar conte√∫do dos detalhes
        function createOrderDetailContent(order) {
            const statusConfig = {
                'pendente': { label: 'Pendente', icon: '‚è≥', class: 'pending' },
                'confirmado': { label: 'Confirmado', icon: '‚úÖ', class: 'confirmed' },
                'em_entrega': { label: 'Em Entrega', icon: 'üöö', class: 'delivering' },
                'entregue': { label: 'Entregue', icon: 'üì¶', class: 'delivered' },
                'cancelado': { label: 'Cancelado', icon: '‚ùå', class: 'cancelled' }
            };
            
            const status = statusConfig[order.status] || statusConfig['pendente'];
            
            return `
                <div class="order-detail-section">
                    <h3>Status do Pedido</h3>
                    <span class="status-badge ${status.class} large">
                        ${status.icon} ${status.label}
                    </span>
                    <p class="order-detail-date">Pedido realizado em ${new Date(order.created_at).toLocaleString('pt-BR')}</p>
                </div>

                <div class="order-detail-section">
                    <h3>üì¶ Produtos</h3>
                    <div class="order-items-list">
                        ${order.items.map(item => `
                            <div class="order-item-row">
                                <div class="order-item-info">
                                    <strong>${item.product_name}</strong>
                                    <span class="order-item-quantity">${item.quantity} ${item.unit}</span>
                                </div>
                                <span class="order-item-price">${formatMoney(item.unit_price * item.quantity)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="order-detail-section">
                    <h3>üìç Endere√ßo de Entrega</h3>
                    <p>
                        ${order.shipping_address.street}, ${order.shipping_address.number}
                        ${order.shipping_address.complement ? `, ${order.shipping_address.complement}` : ''}<br>
                        ${order.shipping_address.neighborhood} - ${order.shipping_address.city}, ${order.shipping_address.state}<br>
                        CEP: ${order.shipping_address.zip_code}
                    </p>
                </div>

                <div class="order-detail-section">
                    <h3>üí∞ Resumo Financeiro</h3>
                    <div class="order-summary">
                        <div class="summary-line">
                            <span>Subtotal:</span>
                            <span>${formatMoney(order.subtotal || 0)}</span>
                        </div>
                        <div class="summary-line">
                            <span>Taxa de Entrega:</span>
                            <span>${formatMoney(order.delivery_fee || 0)}</span>
                        </div>
                        <div class="summary-divider"></div>
                        <div class="summary-line total">
                            <span><strong>Total:</strong></span>
                            <span><strong>${formatMoney(order.total_amount || 0)}</strong></span>
                        </div>
                    </div>
                </div>

                ${order.observations ? `
                <div class="order-detail-section">
                    <h3>üìù Observa√ß√µes</h3>
                    <p>${order.observations}</p>
                </div>
                ` : ''}
            `;
        }

        // Fechar modal de detalhes
        function closeOrderDetail() {
            const modal = document.getElementById('orderDetailModal');
            modal.classList.remove('active');
        }

        // Helpers
        function formatMoney(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        }

        function formatPaymentMethod(method) {
            const methods = {
                'boleto': 'Boleto',
                'transferencia': 'Transfer√™ncia',
                'cartao': 'Cart√£o',
                'prazo': 'A Prazo'
            };
            return methods[method] || method;
        }

        // Logout
        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('authToken');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
