<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Da Horta Distribuidora</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Banner Header -->
    <div class="banner-header" onclick="window.location.href='login.html'" style="cursor: pointer;" title="Voltar para login">
        <img src="images/Header_da_horta.png" alt="Da Horta Distribuidora" class="banner-image">
    </div>

    <!-- Register Container -->
    <main class="container register-page">
        <div class="register-card">
            <div class="register-header">
                <h1>üå± Criar Conta</h1>
                <p>Preencha seus dados para come√ßar a comprar</p>
            </div>

            <div class="alert alert-error hidden" id="registerError">
                <span>‚ö†Ô∏è</span>
                <p id="registerErrorMsg">Erro ao criar conta</p>
            </div>

            <form id="registerForm" class="register-form">
                <!-- Dados de Acesso -->
                <div class="form-section">
                    <h2>üîê Dados de Acesso</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="username">Nome de Usu√°rio *</label>
                            <input type="text" id="username" name="username" placeholder="Escolha um nome de usu√°rio" required>
                        </div>
                        <div class="form-group">
                            <label for="email">E-mail *</label>
                            <input type="email" id="email" name="email" placeholder="seu@email.com" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="password">Senha *</label>
                            <input type="password" id="password" name="password" placeholder="M√≠nimo 6 caracteres" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="passwordConfirm">Confirmar Senha *</label>
                            <input type="password" id="passwordConfirm" name="passwordConfirm" placeholder="Digite novamente" required minlength="6">
                        </div>
                    </div>
                </div>

                <!-- Dados da Empresa -->
                <div class="form-section">
                    <h2>üè¢ Dados da Empresa</h2>
                    
                    <div class="form-group">
                        <label for="businessType">Tipo de Estabelecimento *</label>
                        <select id="businessType" name="businessType" required>
                            <option value="">Selecione...</option>
                            <option value="restaurante">Restaurante</option>
                            <option value="hotel">Hotel</option>
                            <option value="mercado">Mercado</option>
                            <option value="padaria">Padaria</option>
                            <option value="lanchonete">Lanchonete</option>
                            <option value="bar">Bar</option>
                            <option value="cafeteria">Cafeteria</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cnpj">CNPJ *</label>
                            <input type="text" id="cnpj" name="cnpj" placeholder="00.000.000/0000-00" required maxlength="18">
                        </div>
                        <div class="form-group">
                            <label for="ie">Inscri√ß√£o Estadual</label>
                            <input type="text" id="ie" name="ie" placeholder="000.000.000.000">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="razaoSocial">Raz√£o Social *</label>
                        <input type="text" id="razaoSocial" name="razaoSocial" placeholder="Nome jur√≠dico da empresa" required>
                    </div>

                    <div class="form-group">
                        <label for="nomeFantasia">Nome Fantasia *</label>
                        <input type="text" id="nomeFantasia" name="nomeFantasia" placeholder="Nome comercial" required>
                    </div>
                </div>

                <!-- Contato -->
                <div class="form-section">
                    <h2>üìû Contato</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="contactName">Nome do Respons√°vel *</label>
                            <input type="text" id="contactName" name="contactName" placeholder="Nome completo" required>
                        </div>
                        <div class="form-group">
                            <label for="contactPhone">Telefone/WhatsApp *</label>
                            <input type="tel" id="contactPhone" name="contactPhone" placeholder="(11) 99999-9999" required>
                        </div>
                    </div>
                </div>

                <!-- Endere√ßo de Entrega -->
                <div class="form-section">
                    <h2>üìç Endere√ßo de Entrega</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cep">CEP *</label>
                            <input type="text" id="cep" name="cep" placeholder="00000-000" required maxlength="9">
                        </div>
                        <div class="form-group cep-btn-container">
                            <button type="button" class="btn-secondary" onclick="searchCEP()">
                                üîç Buscar CEP
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="street">Endere√ßo *</label>
                        <input type="text" id="street" name="street" placeholder="Rua, Avenida..." required>
                    </div>

                    <div class="form-row">
                        <div class="form-group form-group-small">
                            <label for="number">N√∫mero *</label>
                            <input type="text" id="number" name="number" placeholder="N¬∫" required>
                        </div>
                        <div class="form-group">
                            <label for="complement">Complemento</label>
                            <input type="text" id="complement" name="complement" placeholder="Sala, Andar...">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="neighborhood">Bairro *</label>
                            <input type="text" id="neighborhood" name="neighborhood" placeholder="Bairro" required>
                        </div>
                        <div class="form-group">
                            <label for="city">Cidade *</label>
                            <input type="text" id="city" name="city" placeholder="Cidade" required>
                        </div>
                        <div class="form-group form-group-small">
                            <label for="state">UF *</label>
                            <input type="text" id="state" name="state" placeholder="SP" required maxlength="2">
                        </div>
                    </div>
                </div>

                <!-- Forma de Pagamento Preferida -->
                <div class="form-section">
                    <h2>üí≥ Forma de Pagamento Preferida</h2>
                    
                    <div class="form-group">
                        <label for="paymentType">Tipo de Faturamento *</label>
                        <select id="paymentType" name="paymentType" required onchange="toggleJustificativa()">
                            <option value="">Selecione...</option>
                            <option value="pix">PIX</option>
                            <option value="cartao_credito">Cart√£o de Cr√©dito</option>
                            <option value="boleto_7dias">Boleto com 7 dias</option>
                            <option value="boleto_10dias">Boleto com 10 dias</option>
                            <option value="faturamento">Faturamento (A Prazo)</option>
                        </select>
                    </div>

                    <!-- Justificativa para Faturamento -->
                    <div class="form-group hidden" id="justificativaGroup">
                        <label for="justificativaFaturamento">Justificativa para Faturamento *</label>
                        <textarea 
                            id="justificativaFaturamento" 
                            name="justificativaFaturamento" 
                            rows="4" 
                            placeholder="Por favor, explique o motivo da solicita√ß√£o de faturamento a prazo. Ex: Volume de compras mensal estimado, hist√≥rico comercial, refer√™ncias..."></textarea>
                        <p class="form-hint">
                            ‚ö†Ô∏è O faturamento est√° sujeito a an√°lise de cr√©dito. Nossa equipe entrar√° em contato para validar as informa√ß√µes.
                        </p>
                    </div>

                    <div class="payment-info">
                        <div class="payment-info-item" id="paymentInfoPix" style="display: none;">
                            <span class="payment-info-icon">‚ö°</span>
                            <div>
                                <strong>PIX</strong>
                                <p>Pagamento instant√¢neo. Receba a confirma√ß√£o na hora!</p>
                            </div>
                        </div>
                        <div class="payment-info-item" id="paymentInfoCartao" style="display: none;">
                            <span class="payment-info-icon">üí≥</span>
                            <div>
                                <strong>Cart√£o de Cr√©dito</strong>
                                <p>Parcele em at√© 3x sem juros. Aprova√ß√£o imediata.</p>
                            </div>
                        </div>
                        <div class="payment-info-item" id="paymentInfoBoleto7" style="display: none;">
                            <span class="payment-info-icon">üìÑ</span>
                            <div>
                                <strong>Boleto 7 dias</strong>
                                <p>Vencimento em 7 dias ap√≥s a emiss√£o do pedido.</p>
                            </div>
                        </div>
                        <div class="payment-info-item" id="paymentInfoBoleto10" style="display: none;">
                            <span class="payment-info-icon">üìÑ</span>
                            <div>
                                <strong>Boleto 10 dias</strong>
                                <p>Vencimento em 10 dias ap√≥s a emiss√£o do pedido.</p>
                            </div>
                        </div>
                        <div class="payment-info-item" id="paymentInfoFaturamento" style="display: none;">
                            <span class="payment-info-icon">üìä</span>
                            <div>
                                <strong>Faturamento (A Prazo)</strong>
                                <p>Pagamento faturado conforme acordo comercial. Sujeito a an√°lise de cr√©dito.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Termos -->
                <div class="form-section terms-section">
                    <label class="checkbox-label">
                        <input type="checkbox" id="acceptTerms" required>
                        <span>Aceito os <a href="#" onclick="alert('Termos de uso em breve')">termos de uso</a> e <a href="#" onclick="alert('Pol√≠tica de privacidade em breve')">pol√≠tica de privacidade</a></span>
                    </label>
                </div>

                <button type="submit" class="btn-primary btn-register">
                    Criar Minha Conta
                </button>
            </form>

            <div class="register-footer">
                <p>J√° tem uma conta? <a href="login.html" class="login-link">Fa√ßa login</a></p>
            </div>
        </div>
    </main>

    <!-- API Scripts -->
    <script src="config.js"></script>
    <script src="api-client.js"></script>
    
    <script>
        console.log('üìù P√°gina de cadastro carregada');
        
        // Redirecionar se j√° estiver logado
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (currentUser) {
            window.location.replace('index.html');
        }

        // M√°scara de CNPJ
        document.getElementById('cnpj').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 14) value = value.slice(0, 14);
            
            if (value.length > 12) {
                value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
            } else if (value.length > 8) {
                value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d+)$/, '$1.$2.$3/$4');
            } else if (value.length > 5) {
                value = value.replace(/^(\d{2})(\d{3})(\d+)$/, '$1.$2.$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d+)$/, '$1.$2');
            }
            e.target.value = value;
        });

        // M√°scara de CEP
        document.getElementById('cep').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 8) value = value.slice(0, 8);
            if (value.length > 5) {
                value = value.replace(/^(\d{5})(\d+)$/, '$1-$2');
            }
            e.target.value = value;
        });

        // Toggle Justificativa para Faturamento
        function toggleJustificativa() {
            const paymentType = document.getElementById('paymentType').value;
            const justificativaGroup = document.getElementById('justificativaGroup');
            const justificativaInput = document.getElementById('justificativaFaturamento');
            
            // Esconder todos os info items
            document.querySelectorAll('.payment-info-item').forEach(item => {
                item.style.display = 'none';
            });
            
            // Mostrar info do tipo selecionado
            if (paymentType === 'pix') {
                document.getElementById('paymentInfoPix').style.display = 'flex';
            } else if (paymentType === 'cartao_credito') {
                document.getElementById('paymentInfoCartao').style.display = 'flex';
            } else if (paymentType === 'boleto_7dias') {
                document.getElementById('paymentInfoBoleto7').style.display = 'flex';
            } else if (paymentType === 'boleto_10dias') {
                document.getElementById('paymentInfoBoleto10').style.display = 'flex';
            } else if (paymentType === 'faturamento') {
                document.getElementById('paymentInfoFaturamento').style.display = 'flex';
            }
            
            // Mostrar/esconder justificativa
            if (paymentType === 'faturamento') {
                justificativaGroup.classList.remove('hidden');
                justificativaInput.required = true;
            } else {
                justificativaGroup.classList.add('hidden');
                justificativaInput.required = false;
                justificativaInput.value = '';
            }
        }

        // M√°scara de telefone
        document.getElementById('contactPhone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            
            if (value.length > 10) {
                value = value.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
            } else if (value.length > 6) {
                value = value.replace(/^(\d{2})(\d{4})(\d+)$/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d+)$/, '($1) $2');
            }
            e.target.value = value;
        });

        // Buscar CEP
        async function searchCEP() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            
            if (cep.length !== 8) {
                alert('Digite um CEP v√°lido com 8 d√≠gitos');
                return;
            }

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                
                if (data.erro) {
                    alert('CEP n√£o encontrado');
                    return;
                }

                document.getElementById('street').value = data.logradouro || '';
                document.getElementById('neighborhood').value = data.bairro || '';
                document.getElementById('city').value = data.localidade || '';
                document.getElementById('state').value = data.uf || '';
                
                document.getElementById('number').focus();
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
                alert('Erro ao buscar CEP. Tente novamente.');
            }
        }

        // Handle form submission
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const passwordConfirm = document.getElementById('passwordConfirm').value;
            
            // Validar senhas
            if (password !== passwordConfirm) {
                showError('As senhas n√£o coincidem!');
                return;
            }
            
            if (password.length < 6) {
                showError('A senha deve ter pelo menos 6 caracteres!');
                return;
            }

            // Verificar termos
            if (!document.getElementById('acceptTerms').checked) {
                showError('Voc√™ precisa aceitar os termos de uso');
                return;
            }

            // Verificar justificativa se faturamento
            const paymentType = document.getElementById('paymentType').value;
            if (paymentType === 'faturamento') {
                const justificativa = document.getElementById('justificativaFaturamento').value.trim();
                if (!justificativa || justificativa.length < 20) {
                    showError('Por favor, forne√ßa uma justificativa detalhada para o faturamento (m√≠nimo 20 caracteres)');
                    return;
                }
            }
            
            try {
                const userData = {
                    username: document.getElementById('username').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    password: password,
                    name: document.getElementById('contactName').value.trim(),
                    company: document.getElementById('nomeFantasia').value.trim(),
                    role: 'cliente',
                    // Dados extras para armazenar
                    business_type: document.getElementById('businessType').value,
                    cnpj: document.getElementById('cnpj').value,
                    ie: document.getElementById('ie').value,
                    razao_social: document.getElementById('razaoSocial').value,
                    phone: document.getElementById('contactPhone').value,
                    address: {
                        cep: document.getElementById('cep').value,
                        street: document.getElementById('street').value,
                        number: document.getElementById('number').value,
                        complement: document.getElementById('complement').value,
                        neighborhood: document.getElementById('neighborhood').value,
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value
                    },
                    // Dados de Pagamento
                    payment_preference: {
                        type: document.getElementById('paymentType').value,
                        justificativa: document.getElementById('justificativaFaturamento').value.trim() || null
                    }
                };
                
                console.log('üì§ Enviando dados de cadastro:', userData);
                
                const response = await api.register(userData);
                
                console.log('‚úÖ Cadastro realizado:', response);
                
                // Salvar usu√°rio e redirecionar
                if (response.access_token) {
                    localStorage.setItem('authToken', response.access_token);
                    localStorage.setItem('currentUser', JSON.stringify(response.user));
                }
                
                alert('‚úÖ Conta criada com sucesso! Bem-vindo!');
                window.location.replace('index.html');
                
            } catch (error) {
                console.error('‚ùå Erro ao criar conta:', error);
                showError(error.message || 'Erro ao criar conta. Tente novamente.');
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('registerError');
            const errorMsg = document.getElementById('registerErrorMsg');
            if (errorDiv && errorMsg) {
                errorMsg.textContent = message;
                errorDiv.classList.remove('hidden');
                errorDiv.scrollIntoView({ behavior: 'smooth' });
                setTimeout(() => errorDiv.classList.add('hidden'), 5000);
            }
        }
    </script>
</body>
</html>
